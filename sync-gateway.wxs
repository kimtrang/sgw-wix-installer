<?xml version='1.0' encoding='Windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'
     xmlns:util='http://schemas.microsoft.com/wix/UtilExtension'>

  <?include $(sys.CURRENTDIR)\Config.wxi?>
  <Product Id="*" Name="$(var.Company) $(var.ProductName)" Version="$(var.Version)" Manufacturer="Couchbase Inc."
      UpgradeCode="01510917-D2BC-91D4-FD65-4743E498A007"
      Language="1033" Codepage="1252">

    <Package Id="*" Keywords="Installer" Description="$(var.Company) $(var.ProductName) $(var.Version) Installer"
        Comments="Couchbase is a registered trademark of Couchbase Inc."
        Manufacturer="Couchbase Inc."
        Platform="x64"
        InstallerVersion="500" Languages="1033" Compressed="yes" SummaryCodepage="1252"/>

    <Media Id="1" Cabinet="Couchbase.cab" EmbedCab="yes" DiskPrompt="Only file"/>
    <Property Id="DiskPrompt" Value="$(var.Company) $(var.ProductName) $(var.Version) Installation [1]"/>

    <MajorUpgrade Schedule="afterInstallExecute"
        DowngradeErrorMessage="A later version of $(var.Company) $(var.ProductName) is already installed. Setup will now exit."/>

    <!-- Directory layout -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder" Name="PFiles">
        <Directory Id="$(var.Company)" Name="$(var.Company)">
          <Directory Id="INSTALLDIR" Name="$(var.ProductName)">
            <!-- Contents of this directory generated by heat in Files.wxs -->
            <!-- Also create explicit directory for bin for installer-util -->
            <Directory Id="SGWLogDirectory"/>
            <Directory Id="ServiceSGWComponent"/>
          </Directory>
        </Directory>
      </Directory>
      <!-- Additional directory references for the Desktop and Start Menu folders -->
      <Directory Id="DesktopFolder" Name="Desktop"/>
    </Directory>

    <Feature Id="Complete" Level="1" Title="Couchbase Server" Description="The Complete Package."
        ConfigurableDirectory="INSTALLDIR">
      <!-- All component files from Files.wxs -->
      <ComponentGroupRef Id="SyncGateway"/>
      <!-- All component files from Util.wxs -->
      <!--<ComponentGroupRef Id="InstallerUtil"/> -->
      <!-- "Fake" component group for shortcuts -->
      <ComponentGroupRef Id="Shortcuts"/>
      <ComponentRef Id="CreateLogFolder"/>
      <ComponentRef Id="SGW_WindowService"/>
    </Feature>

    <!-- Extra componentgroup for holding the shortcuts -->
    <SetProperty Id="CONSOLEURL" Value="http://127.0.0.1:4985/" Sequence="execute" Before="CreateShortcuts"/>
    <ComponentGroup Id="Shortcuts">
      <Component Id="ShortCuts" Directory="INSTALLDIR" Guid="1d9bf2ba-19fc-4bc5-a393-6f421449c8e1">
        <RegistryValue Root="HKCU" Key="Software\$(var.Company)\$(var.ProductName)" Name="shortcut" Type="integer" Value="1" KeyPath="yes"/>
        <Shortcut Directory="DesktopFolder" Id="ConsoleShortcut"
          Name="$(var.Company) $(var.ProductName) Console"
          Description="$(var.Company) $(var.ProductName) Console"
          Target="[CONSOLEURL]"
          Icon="CouchbaseIcon"/>
        <RemoveFolder Id="DesktopFolder" On="uninstall" />
      </Component>
    </ComponentGroup>

    <!-- Install SGW window service -->
    <DirectoryRef Id="ServiceSGWComponent">
        <Component Id="SGW_WindowService" Guid="68a8298e-2116-4bd0-95ec-938c07dfdb4d">
          <File Id="sg_service_exe"
                Name="$(var.WinServiceApp)"
                KeyPath="yes"
                Source="$(var.WinServiceApp)"/>
          <ServiceInstall
                   Id="install_SGWService"
                   Name="SyncGateway"
                   DisplayName="Couchbase Sync Gateway"
                   Description="Couchbase Sync Gateway mobile application REST gateway service." Start="demand"
                   Account="NT AUTHORITY\LocalService"
                   ErrorControl="normal"
                   Interactive="no"
                   Type="ownProcess"
                   Arguments='start "[INSTALLDIR]sync_gateway.exe" "[INSTALLDIR]serviceconfig.json" "[INSTALLDIR]var\lib\couchbase\logs\sync_gateway_error.log" '
                   Vital="yes">
          </ServiceInstall>

          <ServiceControl Id="sc_SGWService"
                          Start="install"
                          Stop="both"
                          Remove="uninstall"
                          Name="SyncGateway"
                          Wait="yes">
          </ServiceControl>
        </Component>
    </DirectoryRef>

    <!-- Create SGW required var\lib\couchbase\logs -->
    <DirectoryRef Id="SGWLogDirectory">
        <Directory Id="SGW_VAR" Name="var">
          <Directory Id="SGW_LIB" Name="lib">
            <Directory Id="SGW_COUCHBASE" Name="couchbase">
              <Directory Id="SGW_LOGS" Name="logs">
              <Component Id="CreateLogFolder" Guid="161335d7-6bf2-42e2-a5f4-f7c2a4eac4c5">
              <CreateFolder>
                <util:PermissionEx User="Users" GenericAll="yes" />
              </CreateFolder>
            </Component>
          </Directory>
        </Directory>
      </Directory>
      </Directory>
    </DirectoryRef>

    <!-- See MB-24192. -->
    <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable"/>

    <InstallExecuteSequence>
      <!-- Actions to do when REMOVE set, ie. Uninstall or Major Upgrade -->
    </InstallExecuteSequence>

    <!-- User Interface stuff below -->

    <!-- Icon for Add/Remove dialog -->
    <Icon Id="CouchbaseIcon" SourceFile="$(sys.CURRENTDIR)\assets\couchbase.ico"/>
    <Property Id="ARPPRODUCTICON" Value="CouchbaseIcon" />
    <Property Id="ARPURLINFOABOUT" Value="http://www.couchbase.com/"/>

    <!-- Graphics for installer itself -->
    <WixVariable Id="WixUIDialogBmp" Value="$(sys.CURRENTDIR)\assets\cb_installer_bg.jpg"/>

    <!-- Text message for our custom exit dialog -->
    <Property Id="HYPERLINK_EXITDIALOGOPTIONALTEXT">
      <![CDATA[Couchbase Sync Gateway is installed. Visit <a href="http://127.0.0.1:4985/">http://127.0.0.1:4985/</a> to configure the server. Please note it may take a few moments for the console to become available.]]>
    </Property>

    <!-- Finally load our custom UI sequence -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

  </Product>
</Wix>
